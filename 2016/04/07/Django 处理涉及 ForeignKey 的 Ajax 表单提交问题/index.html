<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="zheduanyin's life and tech blog"><meta name="google-site-verification" content="8SYOuO4rdMGx-YyY_c0pnFhtcLEPMeajMW8ZSbLQ6F4"><title>Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜ - zheduanyin's life and tech blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><link rel="shortcut icon" type="image/x-icon"><link rel="apple-touch-icon"><link rel="apple-touch-icon-precomposed" href="NaN"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div id="header"><div class="site-name"><h1 class="hidden">Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜</h1><a id="logo" href="/.">Loved One çˆ±è¿‡</a><p class="subtitle">ä½ å¯ä»¥çœ‹åˆ°æ¡Œä¸Šæ•£è½ç€ä¸€äº›ä¸»äººçš„ç”Ÿæ´»ç‰‡æ®µå’Œæ€è€ƒè¿‡ç¨‹ï¼Œå¸Œæœ›ä»–ä»¬å¯¹ä½ æœ‰æ‰€å¯å‘ã€‚</p></div><div id="nav-menu"><a href="/."> é¦–é¡µ</a><a href="/archives/"> å½’æ¡£</a><a href="/about/"> å…³äº</a><a href="/atom.xml"> è®¢é˜…</a></div></div><div id="content"><div class="post container"><h1 class="post-title"><a href="/2016/04/07/Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜/">Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜</a></h1><div class="post-meta">Apr 7, 2016<span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/04/07/Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜/" href="/2016/04/07/Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜/#comments" class="ds-thread-count"></a><div class="post-content"><p>å…³äº ModelForm çš„ä½¿ç”¨ï¼ŒDjango å®˜æ–¹æ–‡æ¡£ä¸­ç»™å‡ºäº†ä¸€ä¸ªæŒ‡å®š instance æ¥ç»‘å®šå®ä¾‹çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleForm</span><span class="params">(ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        error_messages = &#123;</span><br><span class="line">            NON_FIELD_ERRORS: &#123;</span><br><span class="line">                <span class="string">'unique_together'</span>: <span class="string">"%(model_name)s's %(field_labels)s are not unique."</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a form to edit an existing Article, but use</span></span><br><span class="line"><span class="comment"># POST data to populate the form.</span></span><br><span class="line">a = Article.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">f = ArticleForm(request.POST, instance=a)</span><br><span class="line">f.save()</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¯¹ä¸å«å¤–é”®çš„ ModelForm å¤„ç†å·²ç»è¶³å¤Ÿï¼Œä½†å¦‚æœ Model åŒ…å«å¤–é”®ï¼Œè€Œè¿™ä¸ªè¯·æ±‚æ¥è‡ª Ajax æ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•æ¥å¤„ç†å®ƒï¼š</p><ol><li>æ¨¡æ‹Ÿ ModelForm æäº¤ã€å¤„ç†å¤–é”®çš„æ–¹å¼ï¼Œå¹¶åœ¨ Ajax ä¸­æ¨¡æ‹Ÿ</li><li>ä½¿ç”¨ request.POST æ„å»ºå‡ºä¸€ä¸ª Model å®ä¾‹ï¼Œç„¶åè®©å®ƒå¯¹å·ï¼ˆpkï¼‰å…¥åº§ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºå®ƒï¼Œå¦åˆ™æ›´æ–°å®ƒï¼‰<br>æœ¬æ–‡å°†åˆ†åˆ«è®¨è®ºä¸¤è€…çš„å®ç°æ–¹æ³•ä¸é€‚ç”¨ç¯å¢ƒ</li></ol><h2 id="æ¨¡æ‹Ÿ-ModelForm-çš„å¤„ç†æ–¹å¼ï¼Œç”¨-Ajax-æäº¤"><a href="#æ¨¡æ‹Ÿ-ModelForm-çš„å¤„ç†æ–¹å¼ï¼Œç”¨-Ajax-æäº¤" class="headerlink" title="æ¨¡æ‹Ÿ ModelForm çš„å¤„ç†æ–¹å¼ï¼Œç”¨ Ajax æäº¤"></a>æ¨¡æ‹Ÿ ModelForm çš„å¤„ç†æ–¹å¼ï¼Œç”¨ Ajax æäº¤</h2><p>å°šæœªç ”ç©¶ï¼ŒæŒ–å‘å ä½å…ˆ</p><h2 id="æ„å»ºå®ä¾‹"><a href="#æ„å»ºå®ä¾‹" class="headerlink" title="æ„å»ºå®ä¾‹"></a>æ„å»ºå®ä¾‹</h2><p>æ„å»ºå®ä¾‹æ˜¯åœ¨ request.POST çš„åŸºç¡€ä¸Šï¼Œå¯¹å…¶è¿›è¡Œè¡¥å……ï¼Œä»è€Œè·å¾—ä¸€ä¸ªå®Œæ•´çš„å®ä¾‹å†…å®¹ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ç»™å‡ºäº†è¿™ä¸ªä¾‹å­ï¼šåœ¨ view ä¸­ä½¿ç”¨ save(commit=False) å¤„ç†ï¼Œç„¶åè¡¥å……æˆ–ä¿®æ”¹å®ä¾‹çš„ç›¸å…³ fieldsã€‚å¦‚æœå®ä¾‹å·²å­˜åœ¨æ•°æ®åº“çš„è¯ï¼Œä½¿ç”¨ update() æ¥æ›´æ–°æ•°æ®åº“å†…å®¹ï¼›å¦‚æœæ˜¯æ–°å»ºçš„æ¡ç›®ï¼Œåˆ™ä½¿ç”¨ save() æ¥æ·»åŠ åˆ°æ•°æ®åº“ã€‚</p><p>è¦å®Œæˆæ›´æ–°ä¸€ä¸ªä¸å­˜åœ¨äºæ•°æ®åº“çš„æ“ä½œéœ€è¦</p><ol><li>é¦–å…ˆæ£€æµ‹å®ƒæ˜¯å¦å·²å­˜åœ¨æ•°æ®åº“</li><li>å¦‚æœå·²å­˜åœ¨ï¼Œé‚£ä¹ˆéœ€è¦æ‰‹åŠ¨æŒ‡å®šå…¶ pk æ¥è·å¾—è¯¥å®ä¾‹</li><li>ç„¶åæ›´æ”¹ç›¸å…³ field å†…å®¹</li><li>æœ€åä½¿ç”¨ update() ä¿å­˜åˆ°æ•°æ®åº“</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">f = AuthorForm(request.POST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> f.is_valid():</span><br><span class="line">    <span class="comment"># Create, but don't save the new author instance.</span></span><br><span class="line">    new_author = f.save(commit=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Modify the author in some way.</span></span><br><span class="line">    new_author.some_field = <span class="string">'some_value'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Save the new instance.</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        new_author.save()</span><br><span class="line">    <span class="keyword">except</span> IntegrityError::</span><br><span class="line">        <span class="comment"># å·²å­˜åœ¨</span></span><br><span class="line">        <span class="comment"># è‹¥è¦è¿™æ ·ä½¿ç”¨ update çš„è¯éœ€è¦åœ¨ cleaned_data ä¸­åŠ å…¥ä¸Šè¿° some_field çš„æ”¹åŠ¨</span></span><br><span class="line">        <span class="comment"># å› ä¸º some_field çš„æ”¹åŠ¨åªåœ¨ new_author ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸èƒ½æ›´æ–°åˆ°æ•°æ®åº“</span></span><br><span class="line">        Author.objects.filter(pk=f.cleaned_data[<span class="string">'pk'</span>]).update(f.cleaned_data)</span><br></pre></td></tr></table></figure><p>Django æœ‰ä¸€ä¸ª update_or_create å·²ç»å®ç°äº†ä¸Šè¿°æ‰€æœ‰åŠŸèƒ½ï¼Œå¯ä»¥é¿å…è¿™ä¸ª try â€¦ except â€¦ åˆ¤æ–­å®ä¾‹æ˜¯å¦å·²å­˜åœ¨</p><p>æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorAddForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="comment"># ç¡®ä¿ pk ä¸æ˜¯å¿…é¡»å­—æ®µ</span></span><br><span class="line">    <span class="comment"># å¦‚æœä¸ä¼ ï¼Œè‡ªåŠ¨è¯†åˆ«ä¸º None</span></span><br><span class="line">    pk = forms.IntegerField(required=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Author</span><br><span class="line">        fields = [<span class="string">'name'</span>, <span class="string">'address'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># ä¸ä¼  pk çš„è¯è¡¨ç¤ºéœ€è¦æ–°å»ºä¸€ä¸ªæ¡ç›®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.cleaned_data[<span class="string">'pk'</span>]:</span><br><span class="line">            <span class="comment"># æ·»åŠ éœ€è¦çš„å¤–é”®</span></span><br><span class="line">            self.cleaned_data[<span class="string">'Origin'</span>] = City.objects.get(Province=<span class="string">'åŒ—äº¬'</span>, City=<span class="string">'åŒ—äº¬'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorsView</span><span class="params">(LoginRequiredMixin, TemplateView)</span>:</span></span><br><span class="line">    template_name = <span class="string">'authors.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        form = AuthorAddForm(request.POST)</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> form.is_valid():</span><br><span class="line">            <span class="keyword">return</span> form.errors</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœ pk ä¸å­˜åœ¨ï¼Œä¸º Noneï¼Œé‚£ä¹ˆ update_or_create åŒ¹é…å¤±è´¥ï¼Œä»è€Œè¿›å…¥ create æµç¨‹</span></span><br><span class="line">            <span class="comment"># å¦åˆ™ pk å­˜åœ¨è¡¨å•ä¸­ï¼Œé‚£ä¹ˆå°è¯•åŒ¹é…æ•°æ®åº“ï¼Œå¦‚æœå‘½ä¸­ï¼Œè¿›è¡Œ update æ“ä½œï¼Œå¦åˆ™è¿›è¡Œ create æ“ä½œ</span></span><br><span class="line">            Author, created = Author.objects.update_or_create(pk=form.cleaned_data[<span class="string">'pk'</span>], defaults=form.cleaned_data)</span><br><span class="line">        <span class="keyword">except</span> DatabaseError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> e.message</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Author.pk</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ update_or_create é€šè¿‡æ£€æµ‹ <code>id=form.cleaned_data[&#39;id&#39;]</code> æ˜¯å¦å­˜åœ¨è€Œåˆ¤æ–­æ˜¯ç”¨ update() è¿˜æ˜¯ create()ï¼Œè€Œä¸è®ºæ˜¯ update è¿˜æ˜¯ createï¼Œéƒ½ä¼šä½¿ç”¨ cleaned_data ä½œä¸ºæ•°æ®æºæ¥å†™å…¥æ•°æ®åº“ã€‚</p></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.iloved.one/2016/04/07/Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜/" data-id="cimtachqi0005818n3gnf82bb" class="article-share-link">åˆ†äº«åˆ°</a><div class="tags"><a href="/tags/Django/">Django</a></div><div class="post-nav"><a href="/2016/04/09/Django-å¼±å¯†ç æ ¡éªŒé‚£äº›äº‹/" class="pre">Django å¼±å¯†ç æ ¡éªŒé‚£äº›äº‹</a><a href="/2016/03/20/Ukulele-See-You-Again/" class="next">See You Again | Ukulele TABè°±</a></div><div data-thread-key="2016/04/07/Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜/" data-title="Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜" data-url="http://blog.iloved.one/2016/04/07/Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">åˆ†äº«åˆ°ï¼š</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">å¾®åš</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQç©ºé—´</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">è…¾è®¯å¾®åš</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">å¾®ä¿¡</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/04/07/Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜/" data-title="Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜" data-url="http://blog.iloved.one/2016/04/07/Django å¤„ç†æ¶‰åŠ ForeignKey çš„ Ajax è¡¨å•æäº¤é—®é¢˜/" data-author-key="1" class="ds-thread"></div></div></div><div id="footer"><div id="footer">Â© <a href="/." rel="nofollow">Loved One çˆ±è¿‡</a><span id="busuanzi_container_site_uv"> ğŸ¼  è®¿å®¢æ•° </span><span id="busuanzi_value_site_uv"></span><span> ğŸµ </span><br><spen>åœ¨è¿™ä¸ªå¥‡è‘©çš„æ—¶ä»£ï¼Œåªæ„¿åšä¸€ä¸ªä¸å¥‡è‘©çš„ç”·äºº</spen></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'ilovedone'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-75688320-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a3ac28266bf59d2c9c476373df7553f8";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script type="text/javascript" src="/js/scroll_to_animation.js?v=0.0.0" async></script></body></html>