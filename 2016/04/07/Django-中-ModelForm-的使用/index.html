<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="zheduanyin's life / mind / tech blog"><meta name="google-site-verification" content="8SYOuO4rdMGx-YyY_c0pnFhtcLEPMeajMW8ZSbLQ6F4"><title>Django ä¸­ ModelForm çš„ä½¿ç”¨ - zheduanyin's life / mind / tech blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><link rel="shortcut icon" type="image/x-icon"><link rel="apple-touch-icon"><link rel="apple-touch-icon-precomposed" href="NaN"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div id="header"><div class="site-name"><h1 class="hidden">Django ä¸­ ModelForm çš„ä½¿ç”¨</h1><a id="logo" href="/.">Loved One</a><p class="subtitle">å£æŒ‚ç›¸ç‰‡æ­£åœ¨è¤ªè‰²ï¼Œæ¡Œè…¿ç»™é˜³å…‰çƒ˜å¾—æš–æ´‹æ´‹çš„ï¼Œåœ°æ¿å’Œå¢™å£éƒ½æ˜¯ç”¨åŸæœ¨ç å‡ºæ¥çš„ï¼Œæ²¡æœ‰åšå¤ªå¤šå¤„ç†ï¼Œç”šè‡³å¯ä»¥é€è¿‡åœ°é¢çš„å°æ ‘æ´çœ‹åˆ°æ ‘ä¸‹åç€å¼¹ Ukulele çš„å°ç”·å­©å„¿</p></div><div id="nav-menu"><a href="/."> é¦–é¡µ</a><a href="/archives/"> å½’æ¡£</a><a href="/about/"> å…³äº</a><a href="/atom.xml"> è®¢é˜…</a></div></div><div id="content"><div class="post container"><h1 class="post-title"><a href="/2016/04/07/Django-ä¸­-ModelForm-çš„ä½¿ç”¨/">Django ä¸­ ModelForm çš„ä½¿ç”¨</a></h1><div class="post-meta">Apr 7, 2016<span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/04/07/Django-ä¸­-ModelForm-çš„ä½¿ç”¨/" href="/2016/04/07/Django-ä¸­-ModelForm-çš„ä½¿ç”¨/#comments" class="ds-thread-count"></a><div class="post-content"><h2 id="ä»€ä¹ˆæ˜¯-ModelForm"><a href="#ä»€ä¹ˆæ˜¯-ModelForm" class="headerlink" title="ä»€ä¹ˆæ˜¯ ModelForm"></a>ä»€ä¹ˆæ˜¯ ModelForm</h2><p>ModelForm æ˜¯ Django ä¸­ç¼–å†™åŸºäº Model å®šåˆ¶è¡¨å•çš„æ–¹æ³•ï¼Œå¯ä»¥æé«˜ Model å¤ç”¨æ€§ã€‚</p><p>ä½¿ç”¨æ—¶ Django ä¼šæ ¹æ® <code>django.db.models.Field</code> (ç”¨äºæ•°æ®åº“è¡”æ¥) è‡ªåŠ¨è½¬åŒ–ä¸º <code>django.forms.Field</code> (ç”¨äºè¡¨å•å‰ç«¯å±•ç¤ºã€åç«¯éªŒè¯)ã€‚</p><h2 id="å®šä¹‰-ModelForm-è¡¨å•"><a href="#å®šä¹‰-ModelForm-è¡¨å•" class="headerlink" title="å®šä¹‰ ModelForm è¡¨å•"></a>å®šä¹‰ ModelForm è¡¨å•</h2><p>ä¸¾ä¸€ä¸ªä¹¦ç±ç®¡ç†ä¾‹å­ï¼Œè¿™ä¸ªä¾‹å­ä¸­å®šä¹‰äº†</p><ul><li>title å­—æ®µï¼Œå­˜ charï¼Œç”¨äºå‚¨å­˜ä¹¦ç±çš„æ ‡é¢˜<ul><li>æœ€å¤§å…è®¸é•¿åº¦ 20</li><li>æ•°æ®åº“å”¯ä¸€å€¼ï¼Œè¿™æ„å‘³ç€æ•°æ®åº“ä¸èƒ½å‚¨å­˜ä¸¤ä¸ªç›¸åŒæ ‡é¢˜çš„ä¹¦</li></ul></li><li>author å­—æ®µï¼Œå­˜ Author çš„å¤–é”®ï¼ŒæŒ‡å‘å‚¨å­˜ä¹¦ç±çš„ä½œè€…</li></ul><p>Model<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">20</span>, unique=<span class="keyword">True</span>)</span><br><span class="line">    author = models.ForeignKey(<span class="string">'Author'</span>)</span><br></pre></td></tr></table></figure></p><p>ModelForm<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br></pre></td></tr></table></figure></p><p>ç”¨ Form æ¥æ„é€ çš„è¯è¿™ä¸ª ModelForm ç±»ä¼¼è¿™æ ·<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    title = forms.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">    author = forms.ModelChoiceField(queryset=Author.objects.all())</span><br></pre></td></tr></table></figure></p><h3 id="å®šåˆ¶-ModelForm-è¡¨å•"><a href="#å®šåˆ¶-ModelForm-è¡¨å•" class="headerlink" title="å®šåˆ¶ ModelForm è¡¨å•"></a>å®šåˆ¶ ModelForm è¡¨å•</h3><p>ModelForm æä¾›äº†è‡ªå®šä¹‰ Fieldã€é”™è¯¯ä¿¡æ¯ã€æ¸²æŸ“æ–¹æ³•ã€æ­£åé€‰æ‹©æ¨¡å‹çš„å­—æ®µç­‰ã€‚</p><p>å¦‚ä½•å®šåˆ¶ ModelForm å‘¢ï¼Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼šMeta (ModelForm ç‹¬æœ‰) å’Œè‡ªå®šä¹‰å­—æ®µ (æ™®é€š Form ä¸­ä¹Ÿå¯ä½¿ç”¨)ã€‚</p><h4 id="Meta"><a href="#Meta" class="headerlink" title="Meta"></a>Meta</h4><p>ModelForm é€šè¿‡ Meta æŠŠ db.Field è‡ªåŠ¨è½¬åŒ–ä¸º forms.Fieldï¼Œå…¶ä¸­æ¶‰åŠåˆ°å‡ æ­¥è½¬åŒ–</p><ul><li>validators ä¸å˜</li><li>æ·»åŠ  widget å±æ€§ï¼Œå³å‰ç«¯çš„æ¸²æŸ“æ–¹å¼</li><li>ä¿®æ”¹ Model åŒ…å«çš„å­—æ®µï¼Œé€šè¿‡ fields æ¥æ‹¿æŒ‡å®šå­—æ®µæˆ–è€…é€šè¿‡ exclude æ¥æ’é™¤æŒ‡å®šå­—æ®µ</li><li>ä¿®æ”¹é”™è¯¯ä¿¡æ¯</li></ul><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä¾‹å­æ¥çœ‹ä¸€çœ‹å¦‚ä½•é€šè¿‡ Meta æ¥è‡ªå®šä¹‰ ModelForm çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        <span class="comment"># æŒ‡å®š Model</span></span><br><span class="line">        model = Article</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Form éœ€è¦ Model ä¸­çš„å“ªå‡ ä¸ª Field</span></span><br><span class="line">        fields = [<span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Form æ’é™¤ Model ä¸­çš„å“ªå‡ ä¸ª Field</span></span><br><span class="line">        exclude = [<span class="string">'author'</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è‡ªå®šä¹‰ error_message</span></span><br><span class="line">        error_messages = &#123;</span><br><span class="line">            <span class="string">'invalid'</span> = <span class="string">'invalid title'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è‡ªå®šä¹‰ widgetï¼Œè¿™é‡Œä½¿ç”¨äº†é•¿ 80 åˆ—ï¼Œå®½ 20 è¡Œçš„ textarea</span></span><br><span class="line">        widgets = &#123;</span><br><span class="line">            <span class="string">'name'</span>: Textarea(attrs=&#123;<span class="string">'cols'</span>: <span class="number">80</span>, <span class="string">'rows'</span>: <span class="number">20</span>&#125;),</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><blockquote><p>Meta çš„ç¼ºç‚¹æ˜¯ä¸èƒ½ä¿®æ”¹å­—æ®µçš„ validatorsï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ validatorsï¼Œéœ€è¦åœ¨ Meta å¤–éƒ¨é‡æ–°å®šä¹‰ä¸€ä¸ªåŒå Field æ¥è¦†ç›–ä¹‹</p></blockquote><h4 id="åœ¨-Form-ä¸­å¦å¤–å®šä¹‰-Field"><a href="#åœ¨-Form-ä¸­å¦å¤–å®šä¹‰-Field" class="headerlink" title="åœ¨ Form ä¸­å¦å¤–å®šä¹‰ Field"></a>åœ¨ Form ä¸­å¦å¤–å®šä¹‰ Field</h4><p>è¿™æ˜¯ Form ä¸­é€šç”¨çš„å®šä¹‰ Field çš„æ–¹æ³•ï¼Œåœ¨ ModelForm ä¸­å®ƒæœ‰ä¸¤ä¸ªä½œç”¨</p><ol><li>è¡¥å…… Model æ²¡æœ‰çš„ Field åˆ°è¡¨å•</li><li>è¦†ç›– Model ä¸­çš„ Field å®šä¹‰</li></ol><p>ä¸”çœ‹ä¸‹é¢çš„ä¾‹å­ï¼ŒArticle ä¸­å·²ç»åŒ…å«äº† title å­—æ®µï¼Œæˆ‘ä»¬åœ¨ ModelForm ä¸­é‡æ–°å®šä¹‰äº†å®ƒï¼ŒæŠŠ CharField æ”¹ä¸ºäº† ChoiceFieldï¼Œå¹¶ä¸”è‡ªå®šä¹‰äº† validatorsã€‚</p><p>æ³¨æ„ï¼šè¦†ç›– title çš„æ—¶å€™ï¼ŒæŠŠ title ä» Meta ä¸­ exclude æ‰æ˜¯å¯é€‰çš„ï¼Œå»ä¸å»æ‰çš„åŒºåˆ«åœ¨äºï¼Œä½ æ˜¯å¦éœ€è¦å®ƒä¸ºä½ æ ¡éªŒ <code>unique=True</code> è¿™ä¸ªæ•°æ®åº“çº§é™åˆ¶ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦æ ¡éªŒï¼Œå› ä¸º ModelForm æ ¡éªŒé€šè¿‡åæˆ‘éœ€è¦æŠŠå®ƒå­˜å…¥æ•°æ®åº“ï¼Œå¦‚æœè¿™é‡Œæ²¡æœ‰æ ¡éªŒçš„è¯ï¼Œç¢°åˆ°åŒæ ‡é¢˜çš„ä¹¦æ•°æ®åº“å°±ä¼šåœ¨å‚¨å­˜æ—¶æŠ¥é”™ï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠè¿™æ­¥æ ¡éªŒæ”¾åœ¨ ModelForm çš„æ ¡éªŒä¸­ï¼Œè€Œä¸æ˜¯åœ¨é€šè¿‡æ ¡éªŒåå†ç”¨ <code>try... catch...</code> æ¥æ•è·å®ƒã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    title = forms.ChoiceFied(choices=((<span class="number">1</span>, <span class="string">'ç½—å®¾æ±‰'</span>), (<span class="number">2</span>, <span class="string">'ç”°ä¼¯å…‰'</span>),), validators=MaxValueValidator(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br></pre></td></tr></table></figure><h3 id="å€¼å¾—ä¸€æçš„ä¸€äº›-Field-è½¬åŒ–"><a href="#å€¼å¾—ä¸€æçš„ä¸€äº›-Field-è½¬åŒ–" class="headerlink" title="å€¼å¾—ä¸€æçš„ä¸€äº› Field è½¬åŒ–"></a>å€¼å¾—ä¸€æçš„ä¸€äº› Field è½¬åŒ–</h3><h4 id="AutoField"><a href="#AutoField" class="headerlink" title="AutoField"></a>AutoField</h4><p>è¯¥ Field ä¸ä¼šå‡ºç°åœ¨ ModelForm è¡¨å•ä¸­ã€‚</p><blockquote><p>æ‰€æœ‰ <code>editable=False</code> çš„ Field éƒ½ä¸ä¼šå‡ºç°åœ¨ ModelForm ä¸­ã€‚</p></blockquote><h4 id="BooleanField"><a href="#BooleanField" class="headerlink" title="BooleanField"></a>BooleanField</h4><p>ç”±äºè¡¨å•æäº¤æ—¶ç»Ÿä¸€è¯†åˆ«ä¸º stringï¼Œè€Œ <code>BooleanField</code> æ˜¯ç”¨ python ä¸­çš„ <code>bool</code> æ¥åˆ¤æ–­çš„ï¼Œæ‰€ä»¥åªè¦ä¼ äº†ä»»æ„éç©ºå€¼ï¼Œ<code>BooleanField</code> éƒ½ä¼šå½“åš True æ¥å¤„ç†ï¼Œè€Œå¦‚æœä¼ äº†ç©ºå€¼ï¼Œç”±äº <code>forms.Field</code> é»˜è®¤å±æ€§æ˜¯ <code>required=True</code>ï¼Œä¼šæ ¡éªŒå¤±è´¥ï¼Œæ‰€ä»¥å¦‚æœä½ éœ€è¦ä¸€ä¸ªå¯ä»¥å¡« False çš„ Fieldï¼Œé‚£ä¹ˆä½ éœ€è¦åœ¨ Form ä¸­æ‰‹åŠ¨è®¾ç½®è¿™ä¸ª Field çš„ <code>required=False</code>ã€‚</p><h4 id="ForeignKey"><a href="#ForeignKey" class="headerlink" title="ForeignKey"></a>ForeignKey</h4><p>ForeignKey è‡ªåŠ¨è½¬åŒ–ä¸º ModelChoiceFieldï¼Œç”¨ä¸‹æ‹‰é€‰é¡¹èœå•æ¸²æŸ“ï¼Œé»˜è®¤æ¸²æŸ“å‡ºæ¥çš„é€‰é¡¹æ˜¾ç¤ºä¸ºå¯¹åº” Field çš„ <code>__str__</code>ï¼Œæäº¤çš„å€¼ä¸ºå¯¹åº” Field çš„ <code>id</code>ï¼Œè¿™äº›éƒ½å¯ä»¥å®šåˆ¶ã€‚</p><p>åœ¨åç«¯æ¥æ”¶æäº¤çš„æ—¶å€™ä¼šè‡ªåŠ¨åœ¨å¯¹åº”çš„ Model ä¸­ç”¨ id å»æ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°åˆ™æŠ›å‡º ValidationErrorã€‚</p><h4 id="ManyToManyField"><a href="#ManyToManyField" class="headerlink" title="ManyToManyField"></a>ManyToManyField</h4><p>ManyToManyField è‡ªåŠ¨è½¬åŒ–ä¸º ModelMultipleChoiceFieldï¼Œç”¨å¤šé€‰æ¡†æ¸²æŸ“ï¼ŒåŒæ ·é»˜è®¤æ¸²æŸ“å‡ºæ¥çš„é€‰é¡¹æ˜¾ç¤ºä¸ºå¯¹åº” Field çš„ <code>__str__</code>ï¼Œæäº¤çš„å€¼ä¸ºå¯¹åº” Field çš„ <code>id</code> å€¼ã€‚</p><p>æ¯”å¦‚æœ‰ä¸ªå« group çš„ ManyToManyFieldï¼Œé€‰ä¸­äº† <code>&#39;finance&#39;</code> <code>&#39;develop&#39;</code> è¿™ä¸¤ä¸ªé€‰é¡¹ï¼Œä»–ä»¬çš„ id åˆ†åˆ«ä¸º 1 å’Œ 2ï¼Œé‚£ä¹ˆä¸–ç•Œä¸Šæäº¤çš„è¡¨å• QueryString å°±æ˜¯ <code>group=1&amp;group=2</code></p><h2 id="åˆå§‹åŒ–-ModelForm-è¡¨å•"><a href="#åˆå§‹åŒ–-ModelForm-è¡¨å•" class="headerlink" title="åˆå§‹åŒ– ModelForm è¡¨å•"></a>åˆå§‹åŒ– ModelForm è¡¨å•</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">form = ArticleForm(request.POST)</span><br></pre></td></tr></table></figure><ul><li>æ ¡éªŒçš„æ—¶å€™å¯ä»¥å®šä¹‰ instance å‚æ•°æ¥ç»™ ModelForm åˆå§‹åŒ–å®ä¾‹ï¼Œå³åç»­çš„ä¿®æ”¹éƒ½ä½œç”¨åœ¨è¿™ä¸ªå®ä¾‹ä¸Š</li><li><p>å¯ä»¥å®šä¹‰ initial å‚æ•°æ¥ç»™ ModelForm åˆå§‹å€¼ï¼ŒåŒå Field ä¼šè¦†ç›– instance çš„å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">article = Article.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">author = Author.objects.first()</span><br><span class="line"></span><br><span class="line">form = ArticleForm(request.POST, instance=article, initial=&#123;<span class="string">'author'</span>: author&#125;)</span><br><span class="line"><span class="comment"># åˆ°è¿™é‡Œçš„æ—¶å€™ form å·²ç»ç»‘å®šåˆ° article å¯¹è±¡äº†ï¼Œå¹¶ä¸” author Field çš„åˆå§‹å€¼ä¸º author å¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> form.is_valid():</span><br><span class="line">    form.save()</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œæ•°æ®åŠ è½½çš„å…ˆåé¡ºåºä¸º instance &lt; initial &lt; request.POST</p></blockquote></li></ul><h2 id="æ ¡éªŒ-ModelForm-è¡¨å•"><a href="#æ ¡éªŒ-ModelForm-è¡¨å•" class="headerlink" title="æ ¡éªŒ ModelForm è¡¨å•"></a>æ ¡éªŒ ModelForm è¡¨å•</h2><blockquote><p>æ³¨æ„ï¼šForm åªä¼šæ£€æŸ¥å†…éƒ¨å®šä¹‰è¿‡çš„ Fieldï¼Œrequest.POST ä¸­å…¶ä½™ keyword éƒ½ä¼šè¢«æ— è§†å’Œè¿‡æ»¤æ‰ï¼Œå³ä¸ä¼šå‡ºç°åœ¨è¿”å›çš„ cleaned_data ä¸­ã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">form = ArticleForm(request.POST)</span><br><span class="line"><span class="comment"># æ ¡éªŒè¡¨å•</span></span><br><span class="line"><span class="keyword">if</span> form.is_valid():</span><br><span class="line">    <span class="comment"># ä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">    article = form.save()</span><br></pre></td></tr></table></figure><p><code>is_valid()</code> ä¼šè°ƒç”¨ <code>full_clean()</code>æ¥å¯¹è¡¨å•è¿›è¡Œå…¨é¢æ ¡éªŒï¼Œå®ƒåˆåˆ†æˆä¸‰æ­¥ï¼ˆå®šä¹‰åœ¨åŸºç±» Formï¼‰ä¸­</p><ol><li>æ ¹æ®æ¯ä¸ª Field æ¥åšå•ä¸ª Field çš„æ ¡éªŒ ( æ¯”å¦‚ title å­—æ®µå°±ä¼šæ ¡éªŒæ˜¯å¦è¶…å‡ºæœ€å¤§å…è®¸é•¿åº¦ 20 ) å…¶ä¸­åœ¨ <code>Field.clean()</code> æ‰§è¡Œè¿‡åæä¾›äº†é’©å­ <code>clean_[field_name]</code></li><li>æ ¹æ® Form å®šä¹‰çš„ Field ä¹‹é—´çš„ä¾èµ–å…³ç³»åšæ•´ä¸ªè¡¨å•çš„æ ¡éªŒï¼Œé’©å­æ–¹æ³•ä¸º <code>clean()</code></li><li>è‡ªå®šä¹‰æ ¡éªŒé€šè¿‡åçš„è¡¨å•å¤„ç†ï¼Œé’©å­å« <code>_post_clean()</code><ul><li>è¿™ä¸€æ­¥ä¸­ï¼ŒModelForm åšäº†ä¸€äº›é¢å¤–çš„æ£€éªŒï¼šå¦‚æœå®šä¹‰åœ¨ Meta ä¸­çš„ Field æœ‰ <code>unique=True</code> è¿™ä¸ªé™åˆ¶ï¼Œé‚£ä¹ˆ ModelForm åˆ™ä¼šæŒ‰ç…§ç°æœ‰æ•°æ®åº“ä¸­çš„æ•°æ®å¯¹å…¶æ ¡éªŒï¼Œçœ‹è¿™ä¸ª Field çš„å€¼æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºä¸€ä¸ª <code>IntegrityError</code>ã€‚å®é™…æ“ä½œä¸­å¦‚æœå¼ºåˆ¶ä¸æ ¡éªŒ unique çš„è¯ï¼Œå¯ä»¥æŠŠè¯¥å­—æ®µä» Meta ä¸­ç§»é™¤ï¼Œåœ¨ ModelForm ä¸­é‡æ–°å®šä¹‰è¯¥å­—æ®µã€‚</li></ul></li></ol><h2 id="å‚¨å­˜-ModelForm-å¯¹è±¡"><a href="#å‚¨å­˜-ModelForm-å¯¹è±¡" class="headerlink" title="å‚¨å­˜ ModelForm å¯¹è±¡"></a>å‚¨å­˜ ModelForm å¯¹è±¡</h2><p>è°ƒç”¨ <code>save()</code> çš„æ—¶å€™å¯ä»¥æ·»åŠ  <code>commit=False</code> æ¥é¿å…ç«‹å³å‚¨å­˜ï¼Œä»è€Œé€šè¿‡åç»­çš„ä¿®æ”¹æˆ–è¡¥å……æ¥å¾—åˆ°å®Œæ•´çš„ Model å®ä¾‹åå†å‚¨å­˜åˆ°æ•°æ®åº“ã€‚</p><p>å¦‚æœåˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥äº† instanceï¼Œé‚£ä¹ˆè°ƒç”¨ <code>save()</code> çš„æ—¶å€™ä¼šç”¨ ModelForm ä¸­å®šä¹‰è¿‡çš„å­—æ®µå€¼è¦†ç›–ä¼ å…¥å®ä¾‹çš„ç›¸åº”å­—æ®µï¼Œå¹¶å†™å…¥æ•°æ®åº“ã€‚</p><p><code>save()</code> åŒæ ·ä¼šå¸®ä½ å‚¨å­˜ ManyToManyFieldï¼Œå¦‚æœ save æ—¶ä½¿ç”¨äº† <code>commit=False</code>ï¼Œé‚£ä¹ˆ ManyToManyField çš„å‚¨å­˜éœ€è¦ç­‰è¯¥æ¡ç›®å­˜å…¥æ•°æ®åº“ä¹‹åæ‰‹åŠ¨è°ƒç”¨ ModelForm çš„ <code>save_m2m()</code> æ–¹æ³•ã€‚</p><h3 id="ä½¿ç”¨åŒä¸€è¡¨å•æ¥-æ–°å»º-æ›´æ–°-æŒ‡å®šå®ä¾‹"><a href="#ä½¿ç”¨åŒä¸€è¡¨å•æ¥-æ–°å»º-æ›´æ–°-æŒ‡å®šå®ä¾‹" class="headerlink" title="ä½¿ç”¨åŒä¸€è¡¨å•æ¥ æ–°å»º | æ›´æ–° æŒ‡å®šå®ä¾‹"></a>ä½¿ç”¨åŒä¸€è¡¨å•æ¥ æ–°å»º | æ›´æ–° æŒ‡å®šå®ä¾‹</h3><p>é€šå¸¸çš„æ­¥éª¤åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥</p><ul><li>æ£€æµ‹è¯¥å¯¹è±¡æ˜¯å¦å·²åœ¨æ•°æ®åº“<ul><li>å¦‚æœå·²å­˜åœ¨ï¼Œé‚£ä¹ˆéœ€è¦æ‰‹åŠ¨è·å–è¯¥å®ä¾‹ï¼Œç„¶åæ›´æ”¹ç›¸å…³ field å†…å®¹ï¼Œæœ€åä½¿ç”¨ <code>update()</code> æ–¹æ³•ä¿å­˜åˆ°æ•°æ®åº“</li><li>å¦‚æœä¸å­˜åœ¨ï¼Œæ–°å»ºä¸€ä¸ª Model å®ä¾‹å¹¶ä¿®æ”¹è‡³å®Œæ•´çš„ Modelï¼Œè°ƒç”¨ <code>save()</code> æ–¹æ³•ä¿å­˜åˆ°æ•°æ®åº“</li></ul></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">f = AuthorForm(request.POST)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> f.is_valid():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Save the new instance.</span></span><br><span class="line">        new_author = f.save(commit=<span class="keyword">False</span>)</span><br><span class="line">        new_author.some_field = f.cleaned_data[<span class="string">'some_field'</span>]</span><br><span class="line">        new_author.save()</span><br><span class="line">    <span class="keyword">except</span> IntegrityError:</span><br><span class="line">        <span class="comment"># å·²å­˜åœ¨</span></span><br><span class="line">        <span class="comment"># è‹¥è¦è¿™æ ·ä½¿ç”¨ update çš„è¯éœ€è¦åœ¨ cleaned_data ä¸­åŠ å…¥ä¸Šè¿° some_field çš„æ”¹åŠ¨</span></span><br><span class="line">        <span class="comment"># å› ä¸º some_field çš„æ”¹åŠ¨åªåœ¨ new_author ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸èƒ½æ›´æ–°åˆ°æ•°æ®åº“</span></span><br><span class="line">        Author.objects.filter(pk=f.cleaned_data[<span class="string">'pk'</span>]).update(f.cleaned_data)</span><br></pre></td></tr></table></figure><p>å¤ªéº»çƒ¦äº†ï¼å…¶å® Django ä¸­å·²ç»æœ‰ <code>update_or_create</code> æ–¹æ³•å·²ç»å®ç°äº†ä¸Šè¿°æ‰€æœ‰åŠŸèƒ½ï¼Œå¯ä»¥é¿å…è¿™ä¸ª <code>try ... except ...</code> åˆ¤æ–­å®ä¾‹æ˜¯å¦å·²å­˜åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹è¿™ä¸ªä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># forms.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorAddForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="comment"># ç¡®ä¿ pk ä¸æ˜¯å¿…é¡»å­—æ®µ</span></span><br><span class="line">    <span class="comment"># å¦‚æœä¸ä¼ ï¼Œè‡ªåŠ¨è¯†åˆ«ä¸º None</span></span><br><span class="line">    pk = forms.IntegerField(required=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Author</span><br><span class="line">        fields = [<span class="string">'name'</span>, <span class="string">'address'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_post_clean</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(forms.ModelForm, self)._post_clean()</span><br><span class="line">        <span class="comment"># ä¸ä¼  pk çš„è¯è¡¨ç¤ºéœ€è¦æ–°å»ºä¸€ä¸ªæ¡ç›®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.cleaned_data[<span class="string">'pk'</span>]:</span><br><span class="line">            <span class="comment"># æ·»åŠ éœ€è¦çš„ Field</span></span><br><span class="line">            self.cleaned_data[<span class="string">'Origin'</span>] = City.objects.get(Province=<span class="string">'åŒ—äº¬'</span>, City=<span class="string">'åŒ—äº¬'</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorsView</span><span class="params">(LoginRequiredMixin, TemplateView)</span>:</span></span><br><span class="line">    template_name = <span class="string">'authors.html'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        form = AuthorAddForm(request.POST)</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> form.is_valid():</span><br><span class="line">            <span class="keyword">return</span> form.errors</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœ pk ä¸å­˜åœ¨ï¼Œä¸º Noneï¼Œé‚£ä¹ˆ update_or_create åŒ¹é…å¤±è´¥ï¼Œä»è€Œè¿›å…¥ create æµç¨‹</span></span><br><span class="line">        <span class="comment"># å¦åˆ™ pk å­˜åœ¨è¡¨å•ä¸­ï¼Œé‚£ä¹ˆå°è¯•åŒ¹é…æ•°æ®åº“ï¼Œå¦‚æœå‘½ä¸­ï¼Œè¿›è¡Œ update æ“ä½œï¼Œå¦åˆ™è¿›è¡Œ create æ“ä½œ</span></span><br><span class="line">        Author, created = Author.objects.update_or_create(pk=form.cleaned_data[<span class="string">'pk'</span>], defaults=form.cleaned_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Author.pk</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>update_or_create</code> é€šè¿‡æ£€æµ‹æ‰€æœ‰é defaults çš„å­—æ®µï¼Œåœ¨ä¸Šè¿°ä¾‹å­ä¸­å°±æ˜¯ <code>id=form.cleaned_data[&#39;id&#39;]</code> ä¸€é¡¹æ˜¯å¦å·²å­˜åœ¨äºæ•°æ®åº“è€Œåˆ¤æ–­æ˜¯ç”¨ <code>update()</code> è¿˜æ˜¯ <code>create()</code>ï¼Œè€Œä¸è®ºæ˜¯ <code>update()</code> è¿˜æ˜¯ <code>create()</code>ï¼Œéƒ½ä¼šä½¿ç”¨ cleaned_data ä½œä¸ºæ•°æ®æºæ¥å†™å…¥æ•°æ®åº“ã€‚</p></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blog.iloved.one/2016/04/07/Django-ä¸­-ModelForm-çš„ä½¿ç”¨/" data-id="circ5r5cs0008h98nsg1jlf8n" class="article-share-link">åˆ†äº«åˆ°</a><div class="tags"><a href="/tags/Django/">Django</a><a href="/tags/Tech/">Tech</a></div><div class="post-nav"><a href="/2016/04/09/Django-å¼±å¯†ç æ ¡éªŒé‚£äº›äº‹/" class="pre">Django å¼±å¯†ç æ ¡éªŒé‚£äº›äº‹</a><a href="/2016/03/20/Ukulele-See-You-Again/" class="next">See You Again | Ukulele TABè°±</a></div><div data-thread-key="2016/04/07/Django-ä¸­-ModelForm-çš„ä½¿ç”¨/" data-title="Django ä¸­ ModelForm çš„ä½¿ç”¨" data-url="http://blog.iloved.one/2016/04/07/Django-ä¸­-ModelForm-çš„ä½¿ç”¨/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">åˆ†äº«åˆ°ï¼š</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">å¾®åš</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQç©ºé—´</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">è…¾è®¯å¾®åš</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">å¾®ä¿¡</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/04/07/Django-ä¸­-ModelForm-çš„ä½¿ç”¨/" data-title="Django ä¸­ ModelForm çš„ä½¿ç”¨" data-url="http://blog.iloved.one/2016/04/07/Django-ä¸­-ModelForm-çš„ä½¿ç”¨/" data-author-key="1" class="ds-thread"></div></div></div><div id="footer"><div id="footer">Â© <a href="/." rel="nofollow">Loved One</a><span id="busuanzi_container_site_uv"> ğŸ¼  è®¿å®¢æ•° </span><span id="busuanzi_value_site_uv"></span><span> ğŸµ </span><br><spen>åœ¨è¿™ä¸ªå¥‡è‘©çš„æ—¶ä»£ï¼Œåªæ„¿åšä¸€ä¸ªä¸å¥‡è‘©çš„ç”·äºº</spen></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'ilovedone'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-75688320-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a3ac28266bf59d2c9c476373df7553f8";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="/js/toc.js?v=0.0.0" async></script><script type="text/javascript" src="/js/scroll_to_animation.js?v=0.0.0" async></script></body></html>